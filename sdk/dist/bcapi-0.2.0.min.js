/* 
* 
* Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.

* Permission is hereby granted, free of charge, to any person obtaining a
* copy of this software and associated documentation files (the "Software"), 
* to deal in the Software without restriction, including without limitation 
* the rights to use, copy, modify, merge, publish, distribute, sublicense, 
* and/or sell copies of the Software, and to permit persons to whom the 
* Software is furnished to do so, subject to the following conditions:
* 
* The above copyright notice and this permission notice shall be included in
* all copies or substantial portions of the Software.
* 
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING 
* FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER 
* DEALINGS IN THE SOFTWARE.
* 
*/!function($){"use strict";$.ajaxSetup({cache:!1}),$.cookie.raw=!0,window.BCAPI={}}(jQuery),function($){BCAPI.Helper={},BCAPI.Helper.Site={},BCAPI.Helper.Site.getAccessToken=function(){if(!$.cookie)return $.error("Include jQuery.cookie or override BCAPI.Helper.Site.getAccessToken with your own implementation.");var location=BCAPI.Helper.Http.getCurrentLocation(),parameters=BCAPI.Helper.Http.getHashFragments(location),paramAccessToken=parameters.access_token,expiresIn=parseInt(parameters.expires_in||""+BCAPI.Config.ACCESS_TOKEN_DEFAULT_EXPIRATION);if(paramAccessToken){var expiryDate=new Date(Date.now());expiryDate.setTime(expiryDate.getTime()+1e3*expiresIn);var cookieOptions={expires:expiryDate,path:"/",secure:!0};$.cookie("access_token",paramAccessToken,cookieOptions)}return paramAccessToken||$.cookie("access_token")},BCAPI.Helper.Site.getRootUrl=function(wnd){wnd=wnd||window;var url=[wnd.location.protocol,"//",wnd.location.hostname].join("");return url},BCAPI.Helper.Site.getSiteId=function(){return"current"},BCAPI.Helper.Http={},BCAPI.Helper.Http.getDecodedParameters=function(paramString){var params=paramString.split("&"),decodedParams={};if(""===params)return{};for(var i=0;i<params.length;i+=1){var param=params[i],firstEqual=param.indexOf("=");p=[],firstEqual>-1&&(p.push(param.substr(0,firstEqual)),p.push(param.substr(firstEqual+1))),2===p.length&&(decodedParams[p[0]]=decodeURIComponent(p[1].replace(/\+/g," ")))}return decodedParams},BCAPI.Helper.Http.getQueryParameters=function(location){return void 0==typeof location.search||0==location.search.length?{}:BCAPI.Helper.Http.getDecodedParameters(location.search.substr(1))},BCAPI.Helper.Http.getHashFragments=function(location){return void 0==typeof location.hash||0==location.hash.length?{}:BCAPI.Helper.Http.getDecodedParameters(location.hash.substr(1))},BCAPI.Helper.Http.getCurrentLocation=function(){return window.location}}(jQuery),function($){var Config={};Config.Pagination={limit:10,skip:0},Config.MAX_DATE="9999-01-01",Config.ACCESS_TOKEN_DEFAULT_EXPIRATION=14400,BCAPI.Config=Config}(jQuery),function($){BCAPI.Models={},BCAPI.Models.Model=Backbone.Model.extend({endpoint:function(){throw new Error("You must provide an endpoint for your model. E.g: /api/v2/persons")},headers:function(){return{Authorization:BCAPI.Helper.Site.getAccessToken()}},urlRoot:function(modelEndpoint){var url=BCAPI.Helper.Site.getRootUrl(),modelEndpoint=modelEndpoint||this.endpoint();return"/"!==modelEndpoint.charAt(0)&&(modelEndpoint="/"+modelEndpoint),url+modelEndpoint},save:function(options){return options=options||{},options.dataType="text",Backbone.Model.prototype.save.call(this,this.attributes,options)},destroy:function(options){return options||(options={}),options.dataType="text",Backbone.Model.prototype.destroy.call(this,options)},sync:function(method,model,options){var customHeaders=this.headers();options.headers=options.headers||{};for(var headerKey in customHeaders)options.headers[headerKey]=customHeaders[headerKey];var xhr=Backbone.Model.prototype.sync.call(this,method,model,options);return xhr.then(function(){return this}).promise(xhr)}}),BCAPI.Models.Collection=Backbone.Collection.extend({initialize:function(){this._defaultLimit=BCAPI.Config.Pagination.limit,this._defaultSkip=BCAPI.Config.Pagination.skip,this._relationFetchPending=0},headers:function(){return this.model.prototype.headers.call()},urlRoot:function(){var modelEndpoint=this.model.prototype.endpoint();return this.model.prototype.urlRoot(modelEndpoint)},fetch:function(options){return options=options||{},options.headers=this.headers(),options.dataType="json",this._limit=options.limit,this._skip=options.skip,options.where&&(this._where=JSON.stringify(options.where)),this._order=options.order,Backbone.Collection.prototype.fetch.call(this,options)},url:function(){var urlWithParams=[this.urlRoot(),"?"];for(var key in this.server_api){var val=this.server_api[key].apply(this);void 0!==val&&(urlWithParams.push("&"),urlWithParams.push(key),urlWithParams.push("="),urlWithParams.push(val))}return urlWithParams[2]="",urlWithParams.join("")},server_api:{limit:function(){return this._limit||this._defaultLimit},skip:function(){return this._skip||this._defaultSkip},where:function(){return this._where},order:function(){return this._order}},parse:function(response){return response.items}})}(jQuery),function($){"use strict";BCAPI.Models.Category=BCAPI.Models.Model.extend({endpoint:function(){return"/api/v2/admin/sites/current/categories"}}),BCAPI.Models.CategoryCollection=BCAPI.Models.Collection.extend({model:BCAPI.Models.Category})}(jQuery),function($){"use strict";BCAPI.Models.Country=BCAPI.Models.Model.extend({endpoint:function(){return"/api/v2/admin/system/countries"}}),BCAPI.Models.CountryCollection=BCAPI.Models.Collection.extend({model:BCAPI.Models.Country})}(jQuery),function($){"use strict";function getParent(x){return"/"==x?BCAPI.Models.FileSystem.Root:new BCAPI.Models.FileSystem.Folder(x)}function mkFilePath(dirPath,name){return"/"==dirPath[dirPath.length-1]?dirPath+name:dirPath+"/"+name}function splitPath(path){var parent,name,index=path.lastIndexOf("/");return 0>index?name=path:(parent=path.substring(0,index),name=path.substring(index+1)),parent||(parent="/"),{parent:parent,name:name}}var FILE_REGEX=/^[^\&\%]+$/,Entity=BCAPI.Models.Model.extend({idAttribute:"path",constructor:function(a1,a2,a3){var attributes,options,initialProps={};if("string"==typeof a1){attributes=a2,options=a3;var path=$.trim(a1);if("/"==path)throw new Error('Cannot instantiate the "/" folder like this. Use BCAPI.Models.FileSystem.Root instead');var o=splitPath(path);initialProps.parent=getParent(o.parent),initialProps.name=o.name}else attributes=a1,options=a2;BCAPI.Models.Model.call(this,attributes,options),initialProps&&this.set(initialProps),this._refreshPath();var model=this;this.on("change:parent sync",function(){model._refreshPath()})},endpoint:function(){return"/api/v2/admin/sites/current/storage"},url:function(){return this.contentUrl()+"?meta"},contentUrl:function(){var p=this.get("path");return"/"==p[0]&&p.substring(1),this.urlRoot()+p},validate:function(attr){return attr.name&&"string"==typeof attr.name&&FILE_REGEX.test(attr.name)?attr.path&&"/"!==attr.path?void 0:"Invalid path for file: ["+attr.path+"]":"Invalid name for file: ["+attr.name+"]"},parse:function(result){var dateStr=result.lastModified;return result.lastModified=new Date(dateStr),result},toJSON:function(){return _.pick(this.attributes,"name")},_refreshPath:function(){this.set("path",mkFilePath(this.get("parent").get("path"),this.get("name")))}});BCAPI.Models.FileSystem={},BCAPI.Models.FileSystem.File=Entity.extend({upload:function(data){return $.ajax(this.contentUrl(),{contentType:"application/octet-stream",type:"PUT",data:data,processData:!1,headers:this.headers()})},uploadAndFetch:function(data){var self=this;return this.upload(data).then(function(){return self.fetch()})},download:function(){return $.ajax(this.contentUrl(),{type:"GET",headers:this.headers()})},initialize:function(){this.set("type","file")}}),BCAPI.Models.FileSystem.Folder=Entity.extend({file:function(name,attributes,options){var fullAttributes=_.extend({parent:this,name:name},attributes);return new BCAPI.Models.FileSystem.File(fullAttributes,options)},initialize:function(){this.set("type","folder")},create:function(){return $.ajax(this.contentUrl()+"?type=folder",{type:"PUT",processData:!1,headers:this.headers()})},parse:function(result){var items=Entity.prototype.parse.call(this,result),parent=this,models=_.map(items.contents,function(obj){return obj.parent=parent,"file"===obj.type?new BCAPI.Models.FileSystem.File(obj):"folder"===obj.type?new BCAPI.Models.FileSystem.Folder(obj):void 0});return items.contents=models,items}});var Root=BCAPI.Models.FileSystem.Folder.extend({constructor:function(){BCAPI.Models.Model.call(this),this.set({path:"/",name:"",parent:null})},validate:function(){},save:function(){throw new Error("Operation not supported")},destroy:function(){throw new Error("Operation not supported")}});BCAPI.Models.FileSystem.Root=new Root}(jQuery),function($){"use strict";BCAPI.Models.WebApp={},BCAPI.Models.WebApp.App=BCAPI.Models.Model.extend({idAttribute:"name",isNotNew:null,isNew:function(){return this.isNotNew?!1:!this.get("id")},endpoint:function(){return"/api/v2/admin/sites/current/webapps"},fetch:function(){return this.isNotNew=!0,Backbone.Model.prototype.fetch.apply(this,arguments)},destroy:function(){return this.isNotNew=!0,Backbone.Model.prototype.destroy.apply(this,arguments)}}),BCAPI.Models.WebApp.AppCollection=BCAPI.Models.Collection.extend({model:BCAPI.Models.WebApp.App,parse:function(response){return response=BCAPI.Models.Collection.prototype.parse.call(this,response)}})}(jQuery),function($){"use strict";BCAPI.Models.WebApp.Country=BCAPI.Models.Model.extend({constructor:function(webappName,attributes,options){BCAPI.Models.Model.call(this,attributes,options),this._webappName=webappName},endpoint:function(){var url=["/api/v2/admin/sites/current/webapps/"];return url.push(this._webappName),url.push("/countries"),url.join("")},toJSON:function(){return this.get("items")},save:function(options){return options=options||{},options.type="PUT",BCAPI.Models.Model.prototype.save.call(this,options)}})}(jQuery),function($){"use strict";var endpointGenerator=function(webappName){return"/api/v2/admin/sites/current/webapps/"+webappName+"/fields"};BCAPI.Models.WebApp.CustomField=BCAPI.Models.Model.extend({constructor:function(webappName,attributes,isNew,options){if(BCAPI.Models.Model.call(this,attributes,options),this._isNew=_.isBoolean(isNew)?isNew:!0,this._isNew&&(_.isUndefined(attributes)||_.isUndefined(attributes.id)))throw new Error("The id for the custom field must be specified.");var id=Number(attributes.id);if(!_.isNumber(id)||_.isNaN(id)||0>=id)throw new Error("The id for the custom field must be a positive number.");this._webappName=webappName,this.set({webapp:new BCAPI.Models.WebApp.App({name:webappName})})},endpoint:function(){return endpointGenerator(this._webappName)},toJSON:function(options){var result=BCAPI.Models.Model.prototype.toJSON.call(this,options);return delete result.webapp,result},isNew:function(){return this._isNew}}),BCAPI.Models.WebApp.CustomFieldCollection=BCAPI.Models.Collection.extend({constructor:function(webappName,attributes,options){BCAPI.Models.Collection.call(this,attributes,options),this._webappName=webappName},model:BCAPI.Models.WebApp.CustomField,urlRoot:function(){return this.model.prototype.urlRoot(endpointGenerator(this._webappName))},parse:function(response){response=BCAPI.Models.Collection.prototype.parse.call(this,response);var fields=[],self=this;return _.each(response,function(field){fields.push(new self.model(self._webappName,field,!1))}),fields}})}(jQuery),function($){"use strict";var endpointGenerator=function(webappName){var url=["/api/v2/admin/sites/current/webapps/"];return url.push(webappName),url.push("/items"),url.join("")};BCAPI.Models.WebApp.Item=BCAPI.Models.Model.extend({constructor:function(webappName,attributes,options){BCAPI.Models.Model.call(this,attributes,options),this._webappName=webappName,this.set({webapp:new BCAPI.Models.WebApp.App({name:webappName})})},endpoint:function(){return endpointGenerator(this._webappName)},toJSON:function(options){var result=BCAPI.Models.Model.prototype.toJSON.call(this,options);return delete result.webapp,result}}),BCAPI.Models.WebApp.ItemCollection=BCAPI.Models.Collection.extend({constructor:function(webappName,models,options){BCAPI.Models.Collection.call(this,models,options),this.webappName=webappName},model:BCAPI.Models.WebApp.Item,urlRoot:function(){return this.model.prototype.urlRoot(endpointGenerator(this.webappName))},parse:function(response){response=BCAPI.Models.Collection.prototype.parse.call(this,response);var items=[],self=this;return _.each(response,function(item){items.push(new self.model(self.webappName,item))}),items}})}(jQuery),function($){"use strict";BCAPI.Models.WebApp.ItemCategory=BCAPI.Models.Model.extend({defaults:{items:[]},constructor:function(webappName,webappItemId,attributes,options){BCAPI.Models.Model.call(this,attributes,options),this._webappName=webappName,this._webappItemId=webappItemId},endpoint:function(){var url=["/api/v2/admin/sites/current/webapps/"];return url.push(this._webappName),url.push("/items/"),url.push(this._webappItemId),url.push("/categories"),url.join("")},toJSON:function(){return this.get("items")},save:function(options){return options=options||{},options.type="PUT",BCAPI.Models.Model.prototype.save.call(this,options)}})}(jQuery);